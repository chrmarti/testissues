name: Mirror Dev Container Features

on:
  workflow_dispatch:

jobs:
  mirror-feature:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        feature: [poetry, ruff, pnpm]

    permissions:
      packages: write  # Allow pushing to ghcr.io/chrmarti

    steps:
      - name: Install ORAS
        run: |
          ORAS_VERSION=$(curl -s https://api.github.com/repos/oras-project/oras/releases/latest | jq -r '.tag_name')
          ORAS_TARBALL="oras_${ORAS_VERSION#v}_$(uname -s)_$(uname -m).tar.gz"

          curl -sL "https://github.com/oras-project/oras/releases/download/${ORAS_VERSION}/${ORAS_TARBALL}" -o oras.tar.gz
          tar -xzf oras.tar.gz oras
          sudo mv oras /usr/local/bin/

      - name: Get tags for ${{ matrix.feature }}
        id: tags
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://ghcr.io/v2/devcontainers-extra/features/${{ matrix.feature }}/tags/list |
            jq -r '.tags[]' > tags.txt

      - name: Mirror tags to chrmarti
        run: |
          while read tag; do
            echo "Copying tag: $tag for feature: ${{ matrix.feature }}"
            oras copy \
              ghcr.io/devcontainers-extra/features/${{ matrix.feature }}:$tag \
              ghcr.io/chrmarti/testissues/${{ matrix.feature }}:$tag \
              --src-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
              --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}"
          done < tags.txt